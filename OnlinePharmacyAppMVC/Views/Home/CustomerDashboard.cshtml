@model OnlinePharmacyAppMVC.DTO.GetMedicine
@{
    Layout = "~/Views/Shared/_LayoutCustomer.cshtml";
    ViewData["Title"] = "Customer Dashboard";
    var userId = Context.Session.GetString("userId");
}

<h2 class="mb-2">Welcome to Contoso Health</h2>
<p class="text-muted mb-4">Click “Add” to instantly place a unit in your cart.</p>

<script>
    const userId = '@userId';
    console.log("User ID:", userId);

    function addToCart(medicineId) {
        const quantityInput = document.getElementById(`qty_${medicineId}`);
        const quantity = parseInt(quantityInput.value);

        const medName = quantityInput.getAttribute("data-name");
        const price = parseFloat(quantityInput.getAttribute("data-price"));

        fetch('https://localhost:7269/api/Cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: parseInt(userId),
                medicineId: medicineId,
                stockQty: quantity,
                medName: medName,
                price: price
            })
        })
        .then(response => {
            if (response.ok) {
                alert("Added to cart successfully!");
            } else {
                alert("Failed to add to cart.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
</script>

<form method="get" asp-action="CustomerDashboard" class="mb-4 d-flex justify-content-end">
    <input type="text"
           name="search"
           value="@Context.Request.Query["search"]"
           class="form-control w-25 me-2"
           placeholder="Search by medicine name..." />
    <button type="submit" class="btn btn-outline-primary">Search</button>
</form>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (Model?.data != null && Model.data.Any())
{
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Composition</th>
                <th>Description</th>
                <th>Manufacturing</th>
                <th>Expiry Date</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Add</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var med in Model.data)
            {
                <tr>
                    <td>@med.medName</td>
                    <td>@med.composition</td>
                    <td>@med.description</td>
                    <td>@med.manufacturing</td>
                    <td>@med.expDate.ToString("dd/MM/yyyy")</td>
                    <td>@med.price.ToString("F2")</td>
                    <td>
                        <input type="number" id="qty_@med.medicineId"
                               value="0" min="0" max="@med.stockQty"
                               data-name="@med.medName"
                               data-price="@med.price" />
                    </td>
                    <td>
                        <button onclick="addToCart(@med.medicineId)">Add</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No medicines available at this time.</p>
}

<div class="mt-4 text-end">
    <form method="get" asp-controller="Cart" asp-action="Index">
        <button type="submit" class="btn btn-primary">Go to Cart</button>
    </form>
</div>


@* <script>
    const userId = '@userId';

    function addToCart(medicineId, medName, unitPrice) {
        fetch('https://localhost:7269/api/Cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: parseInt(userId),
                medicineId: medicineId,
                stockQty: 1,
                medName: medName,
                unitPrice: unitPrice
            })
        })
        .catch(error => console.error("Error adding to cart:", error));
        // ✅ No alert popup — silent success
    }
</script> *@




   @*  <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Composition</th>
                <th>Description</th>
                <th>Manufacturing</th>
                <th>Expiry</th>
                <th>Price (₹)</th>
                <th>Add to Cart</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var med in Model.data)
            {
                <tr>
                    <td>@med.medName</td>
                    <td>@med.composition</td>
                    <td>@med.description</td>
                    <td>@med.manufacturing</td>
                    <td>@med.expDate.ToString("dd/MM/yyyy")</td>
                    <td>@med.price.ToString("F2")</td>
                    <td>
                        <button type="button"
                                class="btn btn-sm btn-success"
                                onclick="addToCart(@med.medicineId, '@med.medName', @med.price)">
                            Add
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table> *@